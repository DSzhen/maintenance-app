<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>新增维保告知单</title>
		<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/wbicon/style.css" />
		<link rel="stylesheet" href="../../css/wbicon/style.css" />
		<link rel="stylesheet" href="../../css/xficon/style.css" />
		<style>
			html {
				font-family: "Microsoft YaHei";
			}
			
			body {
				color: #333;
				background-color: #f5f5f9;
			}
			
			.aui-bg {
				background-color: #fff;
			}
			
			.aui-bg+.aui-bg {
				margin-top: .45rem;
			}
			
			.aui-list .aui-list-item-label {
				width: auto;
				font-size: .75rem;
			}
			
			.aui-list.aui-form-list {
				padding-top: .25rem;
				padding-bottom: .25rem;
			}
			
			.aui-info {
				padding-top: .8rem;
				padding-bottom: .8rem;
			}
			
			.aui-info .aui-info-item {
				font-size: .75rem;
				color: #333;
			}
			
			.aui-info-item a {
				color: #848484;
			}
			
			.aui-list-form .aui-list-item-input {
				padding-right: 0;
			}
			
			.aui-list-form textarea {
				width: 100%;
				height: 5rem;
				margin: 0;
				font-size: .72rem;
				padding: .4rem;
				background-color: #fff;
				border: 1px solid #d6d6d6;
				-webkit-border-radius: .2rem;
				-moz-border-radius: .2rem;
				border-radius: .2rem;
			}
			
			.aui-list-form {
				padding: 1rem 0;
			}
			
			.aui-list-form .aui-list-item-label {
				margin-bottom: .5rem;
				font-size: .75rem;
			}
			
			.aui-list-item-input {
				position: relative;
			}
			
			.wb-voice-icon {
				position: absolute;
				bottom: .05rem;
				right: .3rem;
				color: #ddd;
				font-size: 1.2rem;
			}
			
			.wb-update-img img {
				display: inline-block;
				width: 3rem;
				height: 3rem;
				margin-right: .4rem;
				border: 0;
				background-color: #e0e0e0;
			}
			
			.wb-update-camrea {
				display: inline-block;
				width: 3rem;
				height: 3rem;
				text-align: center;
				line-height: 3rem;
				font-size: 2rem;
				color: #999;
				border: 1px dashed #efefef;
				vertical-align: top;
			}
			
			.wb-update-image {
				padding-top: .8rem;
				padding-bottom: .8rem;
			}
			
			.wb-update-img {
				margin-left: .2rem;
			}
			
			.wb-card-title {
				margin-bottom: .5rem;
				font-size: .75rem;
				color: #333;
			}
			/*照片*/
			
			.wb-card-title {
				padding-left: .5rem;
			}
			
			.wb-update-img img {
				display: inline-block;
				width: 3rem;
				height: 3rem;
				margin-right: .4rem;
				border: 0;
				background-color: #e0e0e0;
			}
			
			.wb-update-camrea {
				display: inline-block;
				width: 3rem;
				height: 3rem;
				text-align: center;
				line-height: 3rem;
				font-size: 2rem;
				color: #999;
				border: 1px dashed #efefef;
				vertical-align: top;
			}
			
			.wb-update-image {
				margin-top: .4rem;
				padding-bottom: .5rem;
			}
			
			.wb-update-img {
				margin-left: .2rem;
			}
			
			.wb-trouble-item {
				display: inline-block;
				padding: .1rem 1rem;
				color: #fff;
				border-radius: 15px;
				background-color: #fff;
			}
			
			.wb-trouble-item.is-active {
				color: #fff;
				background-color: #ff961b;
			}
			
			.wb-pl {
				padding: .5rem;
			}
			/*删除图片*/
			
			.xf-carera-content li {
				position: relative;
				display: inline-block;
				width: 3rem;
				vertical-align: top;
				margin-left: .3rem;
			}
			
			.xf-icon-imgDelete {
				position: absolute;
				right: -.2rem;
				top: -.45rem;
				color: red;
			}
			
			.xf-image-update {
				display: inline-block;
				width: 3rem;
				height: 3rem;
				text-align: center;
				border: 1px solid #ddd;
			}
			
			.xf-image-icon {
				font-size: 2rem;
				line-height: 3rem;
				color: #999;
			}
			
			.xf-iamge-model {
				display: inline-block;
				width: 3rem;
				height: 3rem;
			}
			
			.aui-flex {
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-pack: justify;
				-webkit-justify-content: flex-start;
				justify-content: flex-start;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
			}
			
			.aui-list .aui-list-item {
				border: none;
				background: #fff !important;
			}
			
			textarea::-webkit-input-placeholder {
				color: #c2c2c2;
			}
			.wbicon-voice{
				position: absolute;
			    float: right;
			    right: 1px;
			    margin-top: -24px;
			    margin-right: 8px;
			    color: #A0A0A0;
			}
		</style>
	</head>

	<body>
		<section class="aui-content">
			<div class="aui-bg">
				<ul class="aui-list aui-form-list">
					<li class="aui-list-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-label">提交人：</div>
							<div class="aui-list-item-input aui-margin-l-10">
								<input readonly="readonly" id="userName" type="text" placeholder="请输入提交人姓名">
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="aui-bg">
				<div class="aui-info aui-padded-5 aui-padded-l-15 aui-padded-r-15" onclick="selectownerUnity()">
					<div class="aui-info-item" style="white-space:nowrap">业主单位：</div>
					<div class="aui-info-item" style="width: 80%;">
						<input class="aui-margin-r-10" readonly="readonly" id="unitName" type="text" style="text-align:right">
						<a class="wbicon-arrowRight2"></a>
					</div>
				</div>
			</div>
			<div class="aui-bg">
				<div class="aui-list-form aui-padded-l-15 aui-padded-r-15">
					<div class="aui-list-item-label">故障情况：</div>
					<div class="aui-list-item-input">
						<textarea id="faultDescribe" placeholder="请针对非合同范围内的隐患进行记录，告知业主"></textarea>
						<!--<b onclick="voiceInput('faultDescribe')" class="wbicon-voice"></b>-->
						<!--<a class="wb-voice-icon"><b class="wbicon-voice"></b></a>-->
					</div>
				</div>
			</div>
			<div class="aui-bg">
				<div class="wb-update-image aui-padded-l-15 aui-padded-r-15">
					<div class="wb-flex wb-flex-start wb-item-flexStart">
						<h5 class="wb-card-title">照片：</h5>
						<ul class="xf-carera-content" id="imgUpdate">
							<li class="xf-image-update"><b class="wbicon-camera xf-image-icon" onclick="imageClick()"></b></li>
						</ul>
					</div>
				</div>
			</div>
			<div id="signatureImageDiv" class="aui-bg">
				<div class="aui-info aui-padded-l-15 aui-padded-r-15" onclick="electronicSignature()">
					<div class="aui-info-item">业主单位签名：</div>
					<div class="aui-info-item">
						<a class="wbicon-arrowRight2"></a>
					</div>
				</div>
			</div>
		</section>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/zepto.js"></script>
	<script type="text/javascript" src="../../script/vue.js"></script>
	<script type="text/javascript" src="../../config/config.js"></script>
	<script type="text/javascript" src="../../script/umeng/zhuge.js"></script>
	<script>
		//定义一个变量防止重复请求ajax
		var preventAjaxRepeatSubmit = true;
		var userObj = JSON.parse(localStorage.getItem("userObj"));
		var fileArr = [];
		var base64 = "",
			selectUnitId, selectUnitName;
		apiready = function() {
			$("#userName").val(userObj.username);
			_initApiEvent()
		}
		//上传照片
		function imageClick() {
			api.actionSheet({
				cancelTitle: '取消',
				buttons: ['拍照', '从相册选择']
			}, function(ret, err) {
				var index = ret.buttonIndex;
				if(index == 1) {
					photograph();
				} else if(index == 2) {
					gallery();
				}
			});
		};
		//拍照
		function photograph() {
			api.getPicture({
				sourceType: 'camera',
				encodingType: 'jpg',
				mediaValue: 'pic',
				destinationType: 'url',
				allowEdit: true,
				quality: 50,
				saveToPhotoAlbum: false
			}, function(ret, err) {
				if(ret) {
					var tempData = ret.data;
					if(tempData == '') {
						return
					}
					var res = tempData.split('/');
					fileArr.push(tempData);
					showImgList(fileArr)
				} else {
//					api.toast({
//						msg: '网络异常，请设置网络连接！',
//						location: 'bottom'
//					});
				}
			});
		}

		//从图库选择
		function gallery() {
			api.getPicture({
				sourceType: 'album',
				encodingType: 'jpg',
				mediaValue: 'pic',
				destinationType: 'url',
				allowEdit: true,
				quality: 50,
				saveToPhotoAlbum: false
			}, function(ret, err) {
				if(ret) {
					var tempData = ret.data;
					if(tempData == '') {
						return
					}
					var res = tempData.split('/');
					fileArr.push(tempData);
					showImgList(fileArr)
				} else {
//					api.toast({
//						msg: '网络异常，请设置网络连接！',
//						location: 'bottom'
//					});
				}
			});
		}
		//展示照片数组
		function showImgList(arr) {
			var tpl = "";
			for(var i = 0; i < arr.length; i++) {
				var temp = "";
				temp = imgTpl(arr[i], i)
				tpl += temp
			}
			if(arguments[1]) {
				//  tpl += '<li  class ="display"><img src="../../image/public/1_06.jpg"  class="xf-picture--add_icon" onclick="imageClick()" ><small>上传照片</small></li>' ;
			} else {

				tpl += '<li class="wb-update-camrea"><b class="wbicon-camera" onclick="imageClick()"></b></li>';
			}
			$('#imgUpdate').html(tpl)
		}
		//拼接照片数据
		function imgTpl(src, index, type) {
			if(!src) return ""
			var tempId = random();
			var tpl = '<li id=' + tempId + ' ><a><img class="xf-iamge-model"  src="' + src + '" onclick="openPicture(' + index + ')"  ></a><em onclick="deleteImg(\'' + src + '\',\'' + tempId + '\')" class="xficon-forbindden xf-icon-imgDelete"></em></li>';
			return tpl
		}

		function random() {
			var len = len || 32;
			var chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
			var maxPos = chars.length;
			var pwd = '';
			for(var i = 0; i < len; i++) {
				pwd += chars.charAt(Math.floor(Math.random() * maxPos));
			}
			return pwd
		}
		function deleteImg(src, div) {
			$("#" + div).remove()
			if(fileArr.length > 0) {
				for(var i = 0; i < fileArr.length; i++) {
					if(fileArr[i] == src) {
						fileArr.splice(i, 1);
					}
				}
			}
		}

		function openPicture(index) {
			var res;
			res = fileArr;

			var passObj = {
				"index": index,
				"attaches": res,
				"flag": 1
			}
			api.openWin({
				name: 'picture',
				url: './picture.html',
				rect: {
					x: 0,
					y: 0,
					w: 320,
					h: 480
				},
				pageParam: passObj,
				bounces: true,
				bgColor: 'rgba(0,0,0,0)',
				vScrollBarEnabled: true,
				hScrollBarEnabled: true
			});
		}
		//保存需要添加的数据
		function addMaintenanceInform() {
			if(!selectUnitId || !selectUnitName) {
				api.toast({
					msg: '业主单位不能为空',
					duration: 2000,
					location: 'bottom'
				});
				return
			}
			//校验获取所有信息
			var faultDescribe = $("#faultDescribe").val().trim();
			if(!faultDescribe) {
				api.toast({
					msg: '故障情况内容不能为空',
					duration: 2000,
					location: 'bottom'
				});
				return
			}
			if(fileArr.length == 0) {
				api.toast({
					msg: '照片不能为空',
					duration: 2000,
					location: 'bottom'
				});
				return
			}
			if(preventAjaxRepeatSubmit){
				preventAjaxRepeatSubmit = false;
				api.ajax({
					url: webapp_global.url + "/maintenance/addMaintenanceInform",
					method: 'post',
					dataType: "json",
					timeout:20,
					data: {
						values: {
							userId: userObj.userid,
							userName: userObj.name,
							proprietorId: selectUnitId,
							proprietorName: selectUnitName,
							orgId: userObj.orgId,
							orgName: userObj.orgName,
							faultDescription: faultDescribe,
							base64: base64
						},
						files: {
							files: fileArr
						}
					}
				}, function(ret, err) {
					preventAjaxRepeatSubmit = true;
					api.sendEvent({
						name: 'updateInformingList',
						extra: {}
					});
					api.closeWin();
				})
			}
		}
		//打开电子签名
		function electronicSignature() {
			api.openWin({
				name: "_signature",
				url: './_signature.html',
				rect: {
					x: 0,
					y: 0,
					w: 320,
					h: 480
				},
				pageParam: {},
				bounces: false,
				bgColor: 'rgba(0,0,0,0)',
				vScrollBarEnabled: true,
				hScrollBarEnabled: true
			});
		}
		//选择业主单位
		function selectownerUnity() {
			api.openWin({
				name: "_selectownerUnity",
				url: './_selectownerUnity.html',
				rect: {
					x: 0,
					y: 0,
					w: 320,
					h: 480
				},
				pageParam: {},
				bounces: false,
				bgColor: 'rgba(0,0,0,0)',
				vScrollBarEnabled: false,
				hScrollBarEnabled: false
			});
		}

		function _initApiEvent() {
			api.addEventListener({
				name: 'signatureImage'
			}, function(ret, err) {
				base64 = ret.value.baseImg
				var html = `<div class="aui-flex aui-bg aui-padded-10 aui-padded-l-15">
							<div class="aui-info-item">接收人签名：</div>
							<div class="aui-flex-item aui-margin-l-10">
								<img src="` + ret.value.baseImg + `" style="width: 5rem;"/>
							</div>
						</div>`
				$("#signatureImageDiv").html(html)
			});
			api.addEventListener({
				name: 'selectUnitValue'
			}, function(ret, err) {
				selectUnitId = ret.value.id
				selectUnitName = ret.value.name
				$("#unitName").val(selectUnitName)
			});
			//监听语音输入的值
				api.addEventListener({
					name: 'voiceInputModelValue'
				}, function(ret, err) {
					if(ret && ret.value.pageName == "addInforming"){
						$("#"+ret.value.inputFrame).text(ret.value.value);
					}
				});
				//ios右滑控制
      api.addEventListener({
        name:'swiperight'
      }, function(ret, err){
      });
		}
		//语音录入
			function voiceInput(divId){
				api.openWin({
					name: 'voiceInput',
					url: '../public/voiceInput.html',
					rect: {
						x: 0,
						y: 0,
						w: 320,
						h: 480
					},
					pageParam: {
						"pageName":"addInforming",
						"inputFrame":divId
					},
					bounces: false,
					vScrollBarEnabled: true,
					hScrollBarEnabled: true
				});
			}
	</script>

</html>